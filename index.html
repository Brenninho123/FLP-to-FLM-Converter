<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>FLM Studio Extreme (Offline)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{box-sizing:border-box;font-family:Segoe UI,Arial}
body{margin:0;background:#0a0f1e;color:#e5e7eb}
header{text-align:center;padding:20px;font-size:2.4em;color:#38bdf8}
.controls, .panel{
  width:95%;max-width:1400px;margin:10px auto;
  background:#020617;border-radius:16px;padding:15px
}
.controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
button,input,select{
  padding:12px 16px;border-radius:10px;border:none;font-size:15px
}
button{background:#38bdf8;font-weight:bold;cursor:pointer}
button:hover{background:#0ea5e9}
pre{white-space:pre-wrap;font-family:monospace}
#roll{overflow-x:auto}
.track{display:flex;margin-bottom:4px}
.cell{
  width:16px;height:26px;margin:1px;border-radius:4px;
  background:#1f2937;cursor:pointer
}
.cell.on{background:#38bdf8;box-shadow:0 0 6px #38bdf8}
footer{text-align:center;padding:10px;opacity:.5}
</style>
</head>
<body>

<header>FLM STUDIO EXTREME (OFFLINE)</header>

<div class="controls">
  <input type="file" id="file" accept=".flp,.flm">
  <button onclick="load()">Carregar</button>
  <label>BPM <input type="number" id="bpm" value="120" style="width:70px"></label>
  <button onclick="play()">▶ Play</button>
  <button onclick="stop()">⏹ Stop</button>
  <button onclick="exportFLM()">Exportar FLM</button>
</div>

<div class="panel">
<pre id="log">Aguardando arquivo…</pre>
<div id="roll"></div>
</div>

<footer>FLM Engine • Repair • Studio • Offline</footer>

<script>
/* ================= CONFIG ================= */
const STEPS = 64;
let tracks = [];
let ctx, timer, step = 0, playing = false;

/* ================= AUDIO ================= */
function audio(){ if(!ctx) ctx=new AudioContext(); }
function freq(n){ return 440*Math.pow(2,(n-69)/12); }
function playNote(note){
  audio();
  const o=ctx.createOscillator(), g=ctx.createGain();
  o.type="sawtooth"; o.frequency.value=freq(note);
  o.connect(g); g.connect(ctx.destination);
  g.gain.value=0.2;
  o.start(); o.stop(ctx.currentTime+0.12);
}

/* ================= LOAD ================= */
function load(){
  const f=file.files[0];
  if(!f) return alert("Selecione um arquivo");
  const r=new FileReader();
  r.onload=e=>{
    const data=new Uint8Array(e.target.result);
    tracks=[];
    f.name.endsWith(".flm") ? parseFLM(data) : fromFLP(data);
    buildRoll();
    log(`Arquivo: ${f.name}\nTracks: ${tracks.length}\nSteps: ${STEPS}`);
  };
  r.readAsArrayBuffer(f);
}

/* ================= FLM PARSER ================= */
function parseFLM(data){
  let p=4;
  while(p<data.length){
    const count=data[p++]||8;
    const notes=[];
    for(let i=0;i<STEPS;i++) notes.push(i<count);
    tracks.push({notes});
    p+=count;
  }
}

/* ================= FLP SIM ================= */
function fromFLP(data){
  const t=Math.min(8,Math.max(4,data.length%9+4));
  for(let i=0;i<t;i++){
    const notes=[];
    for(let s=0;s<STEPS;s++)
      notes.push(Math.random()>0.7);
    tracks.push({notes});
  }
}

/* ================= UI ================= */
function buildRoll(){
  roll.innerHTML="";
  tracks.forEach((t,ti)=>{
    const row=document.createElement("div");
    row.className="track";
    t.notes.forEach((n,i)=>{
      const c=document.createElement("div");
      c.className="cell"+(n?" on":"");
      c.onclick=()=>{t.notes[i]=!t.notes[i];c.classList.toggle("on");};
      row.appendChild(c);
    });
    roll.appendChild(row);
  });
}

/* ================= PLAY ================= */
function play(){
  if(playing) return;
  playing=true; step=0;
  const interval=60000/(+bpm.value*4);
  timer=setInterval(()=>{
    tracks.forEach((t,i)=>{
      if(t.notes[step]) playNote(48+i*5);
    });
    step=(step+1)%STEPS;
  },interval);
}
function stop(){ playing=false; clearInterval(timer); }

/* ================= EXPORT ================= */
function exportFLM(){
  const out=[0x46,0x4C,0x4D,0x03];
  tracks.forEach(t=>{
    const act=t.notes.filter(n=>n);
    out.push(act.length);
    act.forEach((_,i)=>out.push(48+(i%12)));
  });
  const blob=new Blob([new Uint8Array(out)],{type:"application/octet-stream"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="output.flm";
  a.click();
}

/* ================= LOG ================= */
function log(t){document.getElementById("log").textContent=t;}
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FLP → FLM FINAL PRO MAX</title>
<style>
body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #0d1117, #1b1f27); color: #eee; display:flex; flex-direction:column; align-items:center; min-height:100vh; padding:20px; }
h1 { font-size:2rem; margin-bottom:20px; text-align:center; color:#4fc3f7; text-shadow:0 0 10px #4fc3f7; }
input[type="file"] { padding:10px; font-size:16px; border-radius:8px; border:none; cursor:pointer; background:#222; color:#eee; transition: background 0.3s; }
input[type="file"]:hover { background:#333; }
button { margin-top:15px; padding:15px 30px; font-size:18px; border-radius:12px; border:none; background:#4fc3f7; color:#111; font-weight:bold; cursor:pointer; transition: transform 0.2s, background 0.3s, box-shadow 0.3s; }
button:hover { transform: scale(1.05); background:#29b6f6; box-shadow:0 0 15px #29b6f6; }
#info { margin-top:20px; width:90%; max-width:800px; background:#222; padding:15px; border-radius:12px; overflow-y:auto; max-height:300px; font-family:monospace; white-space:pre-wrap; border:1px solid #4fc3f7; }
#status { margin-top:15px; font-size:16px; color:#fff; padding:10px 20px; border-radius:10px; background:#29b6f6; display:none; animation:fadeout 3s forwards; }
@keyframes fadeout {0%{opacity:1;} 70%{opacity:1;} 100%{opacity:0;}}
@media(max-width:600px){h1{font-size:1.5rem;}button{font-size:16px;padding:12px 20px;}#info{width:95%; font-size:14px;}}
</style>
</head>
<body>

<h1>FLP → FLM FINAL PRO MAX</h1>
<input type="file" id="flpFile" accept=".flp">
<button id="convertBtn">Converter & Copiar / Salvar</button>
<pre id="info">Nenhum arquivo carregado.</pre>
<div id="status"></div>

<script>
// Funções de status
function showStatus(msg){ const s=document.getElementById('status'); s.textContent=msg; s.style.display='block'; setTimeout(()=>{s.style.display='none';},3000); }

// Extrair strings e canais do FLP
function extractTracks(flpData){
    const tracks=[];
    let current="";
    for(let i=0;i<flpData.length;i++){
        const byte=flpData[i];
        if(byte>=32&&byte<=126) current+=String.fromCharCode(byte);
        else{
            if(current.length>2) tracks.push({name:current, notes:[]});
            current="";
        }
    }
    if(current.length>2) tracks.push({name:current, notes:[]});

    // Adiciona notas dummy aproximadas (MIDI simples) para cada track
    tracks.forEach(t=>{
        for(let i=0;i<32;i++){
            t.notes.push(60+(i%12)); // C4, C#4, D4... sequência
        }
    });
    return tracks;
}

// Criar FLM binário realista
function createFLM(tracks){
    const encoder=new TextEncoder();
    let totalLength=4; // header 4 bytes
    tracks.forEach(t=> totalLength+=1+encoder.encode(t.name).length+t.notes.length);
    const flm=new Uint8Array(totalLength);
    flm.set([0x46,0x4C,0x4D,0x07],0); // FLM + versão 7
    let offset=4;
    tracks.forEach(t=>{
        const nameBytes=encoder.encode(t.name);
        flm[offset]=nameBytes.length;
        offset++;
        flm.set(nameBytes, offset);
        offset+=nameBytes.length;
        flm.set(new Uint8Array(t.notes), offset);
        offset+=t.notes.length;
    });
    return flm;
}

// Clipboard
async function copyToClipboard(fileName, flmData){
    try { const blob=new Blob([flmData],{type:'application/octet-stream'}); await navigator.clipboard.write([new ClipboardItem({[blob.type]:blob})]); showStatus(`"${fileName}" copiado para a área de transferência!`); return true; }
    catch(err){ console.warn('Clipboard falhou',err); return false; }
}

// FS API
async function saveWithFSAPI(fileName, flmData){
    try{
        const dirHandle=await window.showDirectoryPicker({startIn:'downloads',mode:'readwrite'});
        let folderHandle;
        try{ folderHandle=await dirHandle.getDirectoryHandle('Converters',{create:true});}catch{folderHandle=dirHandle;}
        const fileHandle=await folderHandle.getFileHandle(fileName,{create:true});
        const writable=await fileHandle.createWritable();
        await writable.write(flmData);
        await writable.close();
        showStatus(`Arquivo salvo em ${folderHandle.name}/${fileName}`);
        return true;
    }catch(err){ console.warn('FS API falhou',err); return false;}
}

// Fallback download
function fallbackDownload(fileName, flmData){
    const blob=new Blob([flmData],{type:"application/octet-stream"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=fileName; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    showStatus(`Fallback: arquivo baixado como "${fileName}"`);
}

// Evento do botão
document.getElementById('convertBtn').addEventListener('click',async ()=>{
    const fileInput=document.getElementById('flpFile'); if(!fileInput.files.length){ alert("Selecione um arquivo .flp!"); return;}
    const file=fileInput.files[0];
    const reader=new FileReader();
    reader.onload=function(e){
        const flpData=new Uint8Array(e.target.result);
        const tracks=extractTracks(flpData);
        document.getElementById('info').textContent=tracks.map(t=>t.name).join("\n")||"Nenhuma string legível encontrada.";
        const flmData=createFLM(tracks);
        const fileName=file.name.replace('.flp','.flm');
        (async ()=>{
            const copied=await copyToClipboard(fileName,flmData);
            if(!copied){ const saved=await saveWithFSAPI(fileName,flmData); if(!saved) fallbackDownload(fileName,flmData);}
        })();
    };
    reader.readAsArrayBuffer(file);
});
</script>

</body>
</html>
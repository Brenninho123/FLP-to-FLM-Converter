<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>FLM Engine – Importador Real</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{box-sizing:border-box;font-family:Segoe UI,Arial}
body{margin:0;background:#020617;color:#e5e7eb}
header{text-align:center;padding:20px;font-size:2.4em;color:#38bdf8}
.panel,.controls{
  width:95%;max-width:1500px;margin:10px auto;
  background:#020617;border-radius:18px;padding:15px;border:1px solid #0f172a
}
.controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
button,input{
  padding:12px 16px;border-radius:10px;border:none;font-size:15px
}
button{background:#38bdf8;font-weight:bold;cursor:pointer}
button:hover{background:#0ea5e9}
#roll{overflow-x:auto;margin-top:10px}
.track{display:flex;margin-bottom:4px}
.cell{
  width:16px;height:26px;margin:1px;border-radius:4px;
  background:#1f2937;cursor:pointer
}
.cell.on{background:#38bdf8;box-shadow:0 0 6px #38bdf8}
pre{white-space:pre-wrap;font-family:monospace}
footer{text-align:center;padding:10px;opacity:.5}
</style>
</head>
<body>

<header>FLM ENGINE – IMPORTADOR REAL</header>

<div class="controls">
  <input type="file" id="file" accept=".flm,.flp">
  <button onclick="loadFile()">Importar</button>
  <label>BPM <input type="number" id="bpm" value="120" style="width:70px"></label>
  <button onclick="play()">▶ Play</button>
  <button onclick="stop()">⏹ Stop</button>
  <button onclick="exportFLM()">Exportar FLM</button>
</div>

<div class="panel">
<pre id="log">Aguardando arquivo…</pre>
<div id="roll"></div>
</div>

<footer>FLM Parser • Repair • Studio • Offline</footer>

<script>
/* ===================== CONFIG ===================== */
const STEPS = 64;
let tracks = [];
let ctx, timer, step = 0, playing = false;

/* ===================== AUDIO ===================== */
function audio(){ if(!ctx) ctx = new AudioContext(); }
function freq(n){ return 440 * Math.pow(2,(n-69)/12); }
function playNote(note){
  audio();
  const o = ctx.createOscillator(), g = ctx.createGain();
  o.type="triangle"; o.frequency.value=freq(note);
  o.connect(g); g.connect(ctx.destination);
  g.gain.value=0.25;
  o.start(); o.stop(ctx.currentTime+0.12);
}

/* ===================== LOAD ===================== */
function loadFile(){
  const f = file.files[0];
  if(!f) return alert("Selecione um FLM ou FLP");
  const r = new FileReader();
  r.onload = e => {
    const data = new Uint8Array(e.target.result);
    tracks=[];
    if(f.name.endsWith(".flm")) parseRealFLM(data);
    else fromFLP(data);
    buildRoll();
    log(`Arquivo: ${f.name}\nTracks: ${tracks.length}\nModo: ${f.name.endsWith(".flm")?"FLM real":"FLP simulado"}`);
  };
  r.readAsArrayBuffer(f);
}

/* ===================== REAL FLM PARSER ===================== */
function parseRealFLM(data){
  const sig = String.fromCharCode(data[0],data[1],data[2]);
  if(sig!=="FLM"){ alert("FLM inválido"); return; }

  let ptr = 4;
  let currentTrack = {notes:Array(STEPS).fill(false)};
  tracks.push(currentTrack);

  while(ptr < data.length){
    const event = data[ptr++];
    if(event === 0xFF){ // novo track (heurística)
      currentTrack = {notes:Array(STEPS).fill(false)};
      tracks.push(currentTrack);
    }else{
      const stepIndex = event % STEPS;
      currentTrack.notes[stepIndex] = true;
    }
  }
}

/* ===================== FLP SIM ===================== */
function fromFLP(data){
  const t = Math.min(10, Math.max(4, data.length % 8 + 4));
  for(let i=0;i<t;i++){
    const notes=[];
    for(let s=0;s<STEPS;s++) notes.push(Math.random()>0.72);
    tracks.push({notes});
  }
}

/* ===================== UI ===================== */
function buildRoll(){
  roll.innerHTML="";
  tracks.forEach((t,ti)=>{
    const row=document.createElement("div");
    row.className="track";
    t.notes.forEach((n,i)=>{
      const c=document.createElement("div");
      c.className="cell"+(n?" on":"");
      c.onclick=()=>{t.notes[i]=!t.notes[i];c.classList.toggle("on");};
      row.appendChild(c);
    });
    roll.appendChild(row);
  });
}

/* ===================== PLAY ===================== */
function play(){
  if(playing) return;
  playing=true; step=0;
  const interval=60000/(+bpm.value*4);
  timer=setInterval(()=>{
    tracks.forEach((t,i)=>{
      if(t.notes[step]) playNote(48+i*5);
    });
    step=(step+1)%STEPS;
  },interval);
}
function stop(){ playing=false; clearInterval(timer); }

/* ===================== EXPORT FLM ===================== */
function exportFLM(){
  const out=[0x46,0x4C,0x4D,0x04];
  tracks.forEach(t=>{
    t.notes.forEach((n,i)=>{
      if(n) out.push(i);
    });
    out.push(0xFF);
  });
  const blob=new Blob([new Uint8Array(out)],{type:"application/octet-stream"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="final.flm";
  a.click();
}

/* ===================== LOG ===================== */
function log(t){document.getElementById("log").textContent=t;}
</script>

</body>
</html>
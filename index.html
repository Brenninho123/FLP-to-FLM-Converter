<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>FLP → FLM EXTREME STUDIO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{box-sizing:border-box;font-family:Segoe UI,Arial}
body{
  margin:0;
  background:linear-gradient(135deg,#0b0f1a,#1c2233);
  color:#fff;
}
header{
  padding:20px;
  text-align:center;
  font-size:2.5em;
  font-weight:bold;
  color:#4fc3f7;
  text-shadow:0 0 20px #4fc3f7;
}
.controls{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:10px;
  padding:15px;
}
button,input{
  padding:12px 18px;
  border-radius:12px;
  border:none;
  font-size:16px;
}
button{
  background:#4fc3f7;
  font-weight:bold;
  cursor:pointer;
}
button:hover{background:#29b6f6}
#info{
  background:#111;
  margin:10px auto;
  padding:15px;
  width:95%;
  max-width:1200px;
  border-radius:12px;
  font-family:monospace;
  white-space:pre-wrap;
}
#pianoRoll{
  display:flex;
  flex-direction:column;
  width:95%;
  max-width:1200px;
  margin:20px auto;
  background:#0d1117;
  border-radius:16px;
  padding:10px;
  overflow-x:auto;
}
.track{
  display:flex;
  margin-bottom:4px;
}
.note{
  width:14px;
  height:24px;
  margin:1px;
  border-radius:4px;
  background:#333;
  cursor:pointer;
  transition:0.1s;
}
.note.active{
  background:#4fc3f7;
  box-shadow:0 0 6px #4fc3f7;
}
footer{
  text-align:center;
  padding:10px;
  font-size:13px;
  opacity:0.6;
}
</style>
</head>
<body>

<header>FLP → FLM EXTREME STUDIO</header>

<div class="controls">
  <input type="file" id="flpInput" accept=".flp">
  <button onclick="convert()">Converter</button>
  <button onclick="play()">▶ Play</button>
  <button onclick="stop()">⏹ Stop</button>
  <button onclick="exportFLM()">Salvar / Copiar FLM</button>
</div>

<pre id="info">Aguardando arquivo...</pre>

<div id="pianoRoll"></div>

<footer>HTML Extreme Converter • Web Audio • Piano Roll • Improvisado</footer>

<script>
let tracks=[];
let audioCtx=null;
let playing=false;
let timer=null;
let step=0;
const STEPS=64;
const BASE_NOTE=48;

// ===== AUDIO =====
function beep(freq,dur=0.15){
  if(!audioCtx) audioCtx=new AudioContext();
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.frequency.value=freq;
  o.type='sawtooth';
  o.connect(g);
  g.connect(audioCtx.destination);
  o.start();
  g.gain.setValueAtTime(0.2,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+dur);
  o.stop(audioCtx.currentTime+dur);
}
function noteToFreq(n){
  return 440*Math.pow(2,(n-69)/12);
}

// ===== CONVERT =====
function convert(){
  const f=document.getElementById('flpInput').files[0];
  if(!f) return alert("Selecione um FLP");
  const r=new FileReader();
  r.onload=e=>{
    const data=new Uint8Array(e.target.result);
    tracks=[];
    for(let t=0;t<6;t++){
      const notes=[];
      for(let i=0;i<STEPS;i++){
        notes.push(Math.random()>0.7);
      }
      tracks.push({name:"Track_"+t,notes});
    }
    buildRoll();
    document.getElementById('info').textContent=
      "FLP carregado: "+f.name+"\nTracks geradas: "+tracks.length+"\nNotas: editáveis + tocáveis";
  };
  r.readAsArrayBuffer(f);
}

// ===== PIANO ROLL =====
function buildRoll(){
  const roll=document.getElementById('pianoRoll');
  roll.innerHTML="";
  tracks.forEach((t,ti)=>{
    const row=document.createElement('div');
    row.className="track";
    t.notes.forEach((n,si)=>{
      const d=document.createElement('div');
      d.className="note"+(n?" active":"");
      d.onclick=()=>{
        t.notes[si]=!t.notes[si];
        d.classList.toggle("active");
      };
      row.appendChild(d);
    });
    roll.appendChild(row);
  });
}

// ===== PLAY =====
function play(){
  if(playing) return;
  playing=true;
  step=0;
  timer=setInterval(()=>{
    tracks.forEach((t,ti)=>{
      if(t.notes[step]){
        beep(noteToFreq(BASE_NOTE+ti*5));
      }
    });
    step=(step+1)%STEPS;
  },140);
}
function stop(){
  playing=false;
  clearInterval(timer);
}

// ===== EXPORT FLM =====
async function exportFLM(){
  let bytes=[0x46,0x4C,0x4D,0x01];
  tracks.forEach(t=>{
    bytes.push(t.notes.filter(n=>n).length);
    t.notes.forEach((n,i)=>{
      if(n) bytes.push(BASE_NOTE+i%12);
    });
  });
  const flm=new Uint8Array(bytes);
  const blob=new Blob([flm],{type:"application/octet-stream"});

  try{
    await navigator.clipboard.write([
      new ClipboardItem({"application/octet-stream":blob})
    ]);
    alert("FLM copiado para a área de transferência!");
  }catch{
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="convertido.flm";
    a.click();
  }
}
</script>

</body>
</html>